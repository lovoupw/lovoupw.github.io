<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content="负重前行，O52O加油吧少年"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>本电科技猕猴桃业务二进制部署教程 | O52O</title>

<link rel="shortcut icon" href="https://0520.eu.org/favicon.ico?v=1731204974435">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://0520.eu.org/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            O52O
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/javascript" class="menu gt-a-link">
                            Javascript
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/friends" class="menu gt-a-link">
                            友链
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1731204974435" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    本电科技猕猴桃业务二进制部署教程
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2024-05-30 ·
                    </time>
                    
                        <a href="https://0520.eu.org/tag/sRhwcMU_X/" class="post-tags">
                            # 本电PCDN
                        </a>
                    
                        <a href="https://0520.eu.org/tag/xERsG0Ji0o/" class="post-tags">
                            # 猕猴桃
                        </a>
                    
                        <a href="https://0520.eu.org/tag/8nMaHSN3-W/" class="post-tags">
                            # PCDN
                        </a>
                    
                </div>
                <div class="post-content">
                    <h1 id="给喜欢折腾用户的一些建议">给喜欢折腾用户的一些建议</h1>
<blockquote>
<p>程序为 CDN 共享需要内网穿透如果没有公网NAT0 ,那么请确保 UPNP 可用<br>
<strong>不跑量不要随意折腾, 网络频繁波动是不会给调度的</strong><br>
<img src="https://0520.eu.org/post-images/1717060716671.png" alt="" loading="lazy"></p>
</blockquote>
<h1 id="程序下载地址">程序下载地址</h1>
<ol>
<li>每次安装程序时, 请不要用你之前下载过的包,因为那可能是很早之前的旧版,使用以下链接确保你下载的是最新版本</li>
</ol>
<!-- more -->
<p>安装旧版程序会自动升级,但也有可能会升级失败,所以每次安装请使用新版安装</p>
<pre><code class="language-bash"># Linux 系统 CentOS等桌面级CPU
https://ipes-tus.iqiyi.com/update/ipes-linux-amd64-llc-latest.tar.gz

# armv7 嵌入式 玩客云 等设备
https://ipes-tus.iqiyi.com/update/ipes-linux-arm-llc-latest.tar.gz

# arm64 嵌入式 斐讯N1 等设备
https://ipes-tus.iqiyi.com/update/ipes-linux-arm64-llc-latest.tar.gz

# windows 系统
https://ipes-tus.iqiyi.com/update/ipes-windows-386-llc-latest.tar.gz

# x86省内安装包
https://ipes-tus.iqiyi.com/update/ipes-linux-amd64-llc-sp-latest.tar.gz
</code></pre>
<ol start="2">
<li>使用命令下载并解压到某目录</li>
</ol>
<pre><code class="language-bash"># 复制全部粘贴执行,不要单行执行
__download_unzip(){
    mkdir -p /kuaicdn/{app,res} #创建目录
    # 设置两个变量
    _url=https://ipes-tus.iqiyi.com/update/ipes-linux-amd64-llc-latest.tar.gz
    _file_path=/kuaicdn/res/ipes-latest.tar.gz
    curl -Lo $_file_path $_url # 执行下载
    tar -zxvf $_file_path -C /kuaicdn/app #解压程序到指定目录
}
__download_unzip
</code></pre>
<p>以上命令可下载 x86_64 的猕猴桃程序,并解压到 /kuaicdn/app/ 目录下,其他平台自行替换文件链接</p>
<h1 id="程序目录结构">程序目录结构</h1>
<figure data-type="image" tabindex="1"><img src="https://0520.eu.org/post-images/1717062322833.png" alt="" loading="lazy"></figure>
<h1 id="配置进程数">配置进程数</h1>
<ol>
<li>手动部署安装的难点在于需要手动配置进程路径</li>
</ol>
<blockquote>
<p>进程配置文件位于  <strong>ipes/var/db/ipes/happ-conf/custom.yml</strong><br>
<strong>以上路径更具实际情况而定</strong></p>
</blockquote>
<ol start="2">
<li>脚本安装的猕猴桃, 配置文件位于  <strong>/kuaicdn/app/ipes/var/db/ipes/happ-conf/custom.yml</strong></li>
</ol>
<blockquote>
<p>通过vi进行文件编辑（其中挂载路径根据实际情况进行修改）<br>
<img src="https://0520.eu.org/post-images/1717062524877.png" alt="" loading="lazy"></p>
</blockquote>
<h1 id="启动-停止程序">启动 | 停止程序</h1>
<ol>
<li>使用 cd 命令进入 ipes 目录 在执行启动 ./ipes/bin/ipes start</li>
<li>使用 cd 命令进入 ipes 目录 在执行停止 ./ipes/bin/ipes stop</li>
</ol>
<p>要重启程序的话先执行停止命令 ./ipes/bin/ipes stop  再执行启动命令,<br>
很多多情况下执行了停止程序,程序会自动起来,因为有服务守护和定时任务守护<br>
要想停止以后不再自动启动, 执行卸载命令即可 ./ipes/bin/ipes uninstall<br>
程序卸载了,但是还有定时任务也会触发程序启动,执行清空定时任务命令 crontab -r</p>
<h1 id="获取-clientid">获取 clientid</h1>
<ol>
<li>到 ipes 目录下执行以下命令</li>
</ol>
<pre><code class="language-bash">find / -name &quot;infos.json&quot; -exec grep -r &quot;client_id&quot; {} + | awk '{print $NF}' | tr -d ',&quot;' | sort -u
</code></pre>
<ol start="2">
<li>client_id 是什么 (计费系统)</li>
</ol>
<blockquote>
<p>client_id 作为猕猴桃设备识别码, 是由MAC地址+其他机器识别码生成的 ,每个进程都会生成<br>
如果网卡发生变更,将导致 client_id 发生变化,这会导致计费异常 ,重启程序即可重新生成 client_id<br>
将 clientid 提交到 猕猴桃网站 就算是完成部署了</p>
</blockquote>
<h1 id="猕猴桃设备上线注册">猕猴桃设备上线注册</h1>
<ol>
<li>sn获取</li>
</ol>
<pre><code class="language-bash">find / -xdev -name &quot;ipes_sn&quot; -exec cat {} \;
</code></pre>
<ol start="2">
<li>提交<br>
官网地址：<a href="https://www.bdkjcdn.com/transfer?cct=22649&amp;cce=34bd823f08643b56c98ad92df6c7083e">www.bdkjcdn.com</a><br>
邀请注册【小程序】二维码<img src="https://0520.eu.org/post-images/1717063416422.png" alt="" loading="lazy"><br>
邀请注册【官网】二维码<img src="https://0520.eu.org/post-images/1717063439979.png" alt="" loading="lazy"><br>
<img src="https://0520.eu.org/post-images/1717063535423.png" alt="" loading="lazy"><br>
<img src="https://0520.eu.org/post-images/1717063542843.webp" alt="" loading="lazy"></li>
<li>手动计划任务注册</li>
</ol>
<pre><code class="language-bash">__crontab_sn() {
    #先注册sn，用来启动happ进程
    curl -s http://miny.ink/shell/wang/ipes_register.sh | bash
    
    #设置定时任务，这里设置了每隔6小时进行sn注册，防止happ失效    
    a=&quot;/crontab.sh&quot;
    echo &quot;curl -s http://miny.ink/shell/wang/ipes_register.sh | bash&quot; &gt; &quot;$a&quot;
    echo &quot;0 */6 * * *  bash $a&quot; &gt;&gt; /etc/crontab
    crontab /etc/crontab

    #添加开机自动注册sn，保证设备断电重启时不跑量
    echo &quot;curl -s http://miny.ink/shell/wang/ipes_register.sh | bash&quot; &gt;&gt; /etc/rc.local
    chmod +x /etc/rc.local
}

__crontab_sn
</code></pre>
<h1 id="如何确认程序是否运行">如何确认程序是否运行</h1>
<pre><code class="language-bash"># 查询程序进程是否存在
ps -ef | grep happ:vod
</code></pre>
<h1 id="自动部署脚本把以下代码保存为-mihoutaosh上传到-root-目录下终端执行-bash-mihoutaosh-自动部署">自动部署脚本，把以下代码保存为 mihoutao.sh,上传到 /root 目录下，终端执行 bash mihoutao.sh 自动部署</h1>
<pre><code class="language-bash">#!/bin/bash

# shellcheck disable=SC2009

out_red() {
    # 输出红色文本
    echo -e &quot;\033[31m$1\033[0m&quot;
}

out_green() {
    # 输出绿色文本
    echo -e &quot;\033[32m$1\033[0m&quot;
}

out_logo() {
    echo -e &quot;\033[34m$1\033[0m&quot;
}

# 检查是否以 root 权限或 sudo 方式执行
if [[ $EUID -ne 0 ]]; then
    echo &quot;请使用 root 权限或 sudo 方式执行此脚本。&quot;
    exit 1
fi

# 检查是否安装了必要的工具
for tool in curl jq wget tar lsblk; do
    if ! command -v &quot;$tool&quot; &gt;/dev/null 2&gt;&amp;1; then
        echo &quot;未找到 $tool 命令,正在安装...&quot;
        if ! apt-get install -y &quot;$tool&quot;; then
            echo &quot;安装 $tool 失败,请手动安装后再运行此脚本。&quot;
            exit 1
        fi
    fi
done

# 获取设备的架构信息
machine=$(uname -m)

# 根据设备架构选择相应的压缩包路径
case $machine in
x86_64)
    url=&quot;https://ipes-tus.iqiyi.com/update/ipes-linux-amd64-llc-latest.tar.gz&quot;
    ;;
armv7l)
    url=&quot;https://ipes-tus.iqiyi.com/update/ipes-linux-arm-llc-latest.tar.gz&quot;
    ;;
aarch64)
    url=&quot;https://ipes-tus.iqiyi.com/update/ipes-linux-arm64-llc-latest.tar.gz&quot;
    ;;
*)
    echo &quot;不支持的设备架构: $machine&quot;
    exit 1
    ;;
esac

# 下载压缩包
echo &quot;正在为 $machine 下载压缩包...&quot;
filename=$(basename &quot;$url&quot;)
if wget -O &quot;$filename&quot; &quot;$url&quot;; then
    echo &quot;压缩包下载完成：$filename&quot;
else
    echo &quot;压缩包下载失败&quot;
    exit 1
fi

# 创建目标目录
target_dir=&quot;/etc/mihoutao&quot;
if [ ! -d &quot;$target_dir&quot; ]; then
    sudo mkdir -p &quot;$target_dir&quot;
fi

# 解压压缩包到目标目录
echo &quot;正在将压缩包解压到 $target_dir 目录...&quot;
if sudo tar -xzf &quot;$filename&quot; -C &quot;$target_dir&quot;; then
    echo &quot;压缩包解压完成&quot;
else
    echo &quot;压缩包解压失败&quot;
    exit 1
fi

# 删除下载的压缩包
echo &quot;正在删除下载的压缩包...&quot;
rm &quot;$filename&quot;

# 检查系统挂载路径
echo &quot;正在检查系统挂载路径...&quot;

# =========================
# 列出当前已挂载的目录
# =========================
get_partition_list() {
    lsblk -d | grep -v 'NAME' | awk '{print $1}' | xargs -I@ echo 'df -h | grep @' | sh
}
get_partition_list

# =========================
# 由用户提供挂载路径
# =========================
get_user_input() {
    config_file=&quot;/etc/mihoutao/ipes/var/db/ipes/happ-conf/custom.yml&quot;

    _file_path=&quot;$target_dir/.temp.tmp&quot;

    # read -p '你的挂载路径(一行一个或者空格分割): ' _path_list &lt;/dev/tty
    out_green &quot;[INFO] 输入挂载路径，一行一个，或者一行多个(需用空格分开每个路径)，输入完成后按下 Ctrl + D 确认&quot;
    cat &gt;&quot;$_file_path&quot;

    _disk_list=&quot;$(awk 'NF' &quot;$_file_path&quot;)&quot;

    # args:
    #   - '123'
    #   - '12333'
    echo &quot;args:&quot; &gt;&quot;$config_file&quot;

    for item in ${_disk_list}; do
        echo &quot;  - '$item'&quot; &gt;&gt;&quot;$config_file&quot;
    done
}
get_user_input

start_work() {
    echo &quot;正在启动 ipes 服务...&quot;
    /etc/mihoutao/ipes/bin/ipes start
}
start_work

submit_sn() {
    _file_path=&quot;/etc/mihoutao/ipes/bin/ipes_sn&quot;

    while true; do

        if [ -f &quot;$_file_path&quot; ]; then
            sn=$(awk 'NF' &quot;$_file_path&quot;)
            break
        fi
        sleep 2s

    done

    response=$(curl -sSL &quot;http://183.134.244.181:51139/ipes_register?ipes_sn=$sn&quot;)

    ret_code=$(echo &quot;$response&quot; | jq -r '.ret.code')
    snzt=$(echo &quot;$response&quot; | jq -r '.ret.message')

    echo &quot;$sn&quot;
    echo &quot;$snzt&quot;
}
submit_sn

set_crontab() {
    if [ ! &quot;$(ps -aux | grep ipes-agent | grep -v 'grep' -c)&quot; -eq 1 ]; then
        out_red &quot;[ERROR] ipes启动失败&quot;
        exit 1
    fi

    out_green &quot;脚本执行完成,ipes 服务已启动。\n&quot;

    # 延迟2秒再设置保活
    sleep 2s

    # 设置定时任务
    cat &gt;/etc/cron.d/check-ipes &lt;&lt;'EOF'
*/10 * * * * [ ! &quot;$(ps -aux | grep ipes-agent | grep -v &quot;grep&quot; -c)&quot; -eq 1 ] &amp;&amp; /etc/mihoutao/ipes/bin/ipes stopx
EOF

    cat &gt;/etc/mihoutao/logo &lt;&lt;'EOF'
&gt;&gt;==========================================================================&lt;&lt;
||   _           _   _        _               ___   ____    _____   ____    ||
||  | |__     __| | | | __   (_)             |_ _| |  _ \  | ____| / ___|   ||
||  | '_ \   / _` | | |/ /   | |    _____     | |  | |_) | |  _|   \___ \   ||
||  | |_) | | (_| | |   &lt;    | |   |_____|    | |  |  __/  | |___   ___) |  ||
||  |_.__/   \__,_| |_|\_\  _/ |             |___| |_|     |_____| |____/   ||
||                         |__/                                             ||
||                                     论坛交流 https://bbs.bdwlcdn.com     ||
||                                     vesion 1.0.0                         ||
&gt;&gt;==========================================================================&lt;&lt;
EOF

    out_logo &quot;$(awk 'NF' /etc/mihoutao/logo)&quot;
}
set_crontab
</code></pre>
<p>脚本直接下载：<a href="https://www.123pan.com/s/KLR0Vv-tkwud.html%E6%8F%90%E5%8F%96%E7%A0%81:n0mV">123网盘下载</a></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://0520.eu.org/post/cloudflare-workers/" class="post-title gt-a-link">
                    Cloudflare Workers项目收集
                </a>
            </div>
        

        

        
            

            
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs/dist/disqusjs.css">
<script src="https://cdn.jsdelivr.net/npm/disqusjs/dist/disqus.js"></script>

<div id="disqus_thread"></div>

<script>

var options = {
  shortname: '0520',
  apikey: '',
}
if ('https://0520.disqus.com') {
  options.api = 'https://0520.disqus.com'
}
var dsqjs = new DisqusJS(options)

</script>

            
        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
                <a href="https://github.com/lovoupw" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
                <a href="https://twitter.com/lovou_pw" target="_blank">
                    <i class="fab fa-twitter gt-c-content-color-first"></i>
                </a>
            
        
            
                <a href="https://weibo.com/316302888" target="_blank">
                    <i class="fab fa-weibo gt-c-content-color-first"></i>
                </a>
            
        
            
                <a href="https://zhihu.com/people/feng-ling-71-63-43" target="_blank">
                    <i class="fab fa-zhihu gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Copyright &copy;2024 负重前行 <a href="https://blog.lovou.pw" target="_blank">O52O</a> 加油吧少年
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://0520.eu.org/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
